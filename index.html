<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mario Mobile Game</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #87CEEB;
  touch-action: none;
}

canvas {
  display: block;
}

.controls {
  position: fixed;
  bottom: 30px;
  left: 20px;
}

.joystick {
  width: 120px;
  height: 120px;
  background: rgba(0,0,0,0.3);
  border-radius: 50%;
  position: relative;
}

.stick {
  width: 50px;
  height: 50px;
  background: rgba(0,0,0,0.6);
  border-radius: 50%;
  position: absolute;
  left: 35px;
  top: 35px;
  transition: 0.05s;
}

.jump {
  position: fixed;
  bottom: 40px;
  right: 40px;
  width: 90px;
  height: 90px;
  border-radius: 50%;
  border: none;
  background: rgba(0,0,0,0.5);
  color: white;
  font-size: 30px;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div class="controls">
  <div class="joystick" id="joystick">
    <div class="stick" id="stick"></div>
  </div>
</div>

<button class="jump" id="jump">▲</button>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let gravity = 0.6;

const player = {
  x: 100,
  y: 100,
  w: 40,
  h: 40,
  vx: 0,
  vy: 0,
  speed: 5,
  jump: -14,
  onGround: false
};

let cameraX = 0;
let score = 0;

const platforms = [
  {x:0,y:420,w:3000,h:40},
  {x:300,y:340,w:150,h:20},
  {x:550,y:280,w:150,h:20},
  {x:800,y:220,w:150,h:20},
  {x:1050,y:300,w:150,h:20}
];

const coins = [
  {x:350,y:300,taken:false},
  {x:600,y:240,taken:false},
  {x:850,y:180,taken:false},
  {x:1100,y:260,taken:false}
];

// Исправленные враги
const enemies = [
  {x:500,y:390,w:40,h:30,dir:1,start:500},
  {x:900,y:390,w:40,h:30,dir:-1,start:900}
];

let move = 0;

function update() {
  player.vx = move * player.speed;

  player.vy += gravity;
  player.x += player.vx;
  player.y += player.vy;

  player.onGround = false;

  platforms.forEach(p=>{
    if(
      player.x < p.x+p.w &&
      player.x+player.w > p.x &&
      player.y < p.y+p.h &&
      player.y+player.h > p.y
    ){
      if(player.vy > 0){
        player.y = p.y-player.h;
        player.vy = 0;
        player.onGround = true;
      }
    }
  });

  coins.forEach(c=>{
    if(!c.taken){
      if(Math.abs(player.x-c.x)<40 && Math.abs(player.y-c.y)<40){
        c.taken = true;
        score++;
      }
    }
  });

  enemies.forEach(e=>{
    e.x += e.dir * 2;

    if(e.x < e.start - 120 || e.x > e.start + 120){
      e.dir *= -1;
    }

    if(
      player.x < e.x+e.w &&
      player.x+player.w > e.x &&
      player.y < e.y+e.h &&
      player.y+player.h > e.y
    ){
      alert("Game Over");
      location.reload();
    }
  });

  cameraX = player.x - canvas.width/2;
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.translate(-cameraX,0);

  ctx.fillStyle="#5c3a1e";
  platforms.forEach(p=>{
    ctx.fillRect(p.x,p.y,p.w,p.h);
  });

  coins.forEach(c=>{
    if(!c.taken){
      ctx.beginPath();
      ctx.arc(c.x,c.y,10,0,Math.PI*2);
      ctx.fillStyle="gold";
      ctx.fill();
    }
  });

  ctx.fillStyle="green";
  enemies.forEach(e=>{
    ctx.fillRect(e.x,e.y,e.w,e.h);
  });

  ctx.fillStyle="red";
  ctx.fillRect(player.x,player.y,player.w,player.h);

  ctx.restore();

  ctx.fillStyle="black";
  ctx.font="20px Arial";
  ctx.fillText("Coins: "+score,20,30);
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

// ДЖОЙСТИК
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

joystick.addEventListener("pointerdown", e=>{
  moveJoystick(e);
});

joystick.addEventListener("pointermove", e=>{
  if(e.buttons) moveJoystick(e);
});

joystick.addEventListener("pointerup", resetJoystick);
joystick.addEventListener("pointerleave", resetJoystick);

function moveJoystick(e){
  const rect = joystick.getBoundingClientRect();
  const x = e.clientX - rect.left - 60;

  stick.style.left = (x + 35) + "px";

  if(x < -20) move = -1;
  else if(x > 20) move = 1;
  else move = 0;
}

function resetJoystick(){
  move = 0;
  stick.style.left = "35px";
}

// ПРЫЖОК
document.getElementById("jump").addEventListener("pointerdown", ()=>{
  if(player.onGround){
    player.vy = player.jump;
  }
});
</script>

</body>
</html>

