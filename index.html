<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mini Platformer</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:linear-gradient(#87CEEB,#dff6ff);
  touch-action:none;
  font-family:Arial;
}

canvas{display:block}

.ui{
  position:fixed;
  inset:0;
  pointer-events:none;
}

.score{
  position:absolute;
  top:15px;
  left:15px;
  background:#ffffffcc;
  padding:8px 12px;
  border-radius:10px;
  font-weight:bold;
}

.controls{
  position:absolute;
  bottom:25px;
  left:20px;
  pointer-events:auto;
}

.joystick{
  width:120px;
  height:120px;
  background:#0003;
  border-radius:50%;
  position:relative;
}

.stick{
  width:50px;
  height:50px;
  background:#0008;
  border-radius:50%;
  position:absolute;
  left:35px;
  top:35px;
}

.jump{
  position:absolute;
  right:30px;
  bottom:30px;
  width:90px;
  height:90px;
  border-radius:50%;
  border:none;
  font-size:30px;
  background:#ff6b6bcc;
  color:white;
  pointer-events:auto;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div class="ui">
  <div class="score" id="score">Coins: 0</div>

  <div class="controls">
    <div class="joystick" id="joy">
      <div class="stick" id="stick"></div>
    </div>
  </div>

  <button class="jump" id="jump">▲</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize",resize);

let gravity = 0.6;

const player={
  x:120,
  y:0,
  w:40,
  h:50,
  vx:0,
  vy:0,
  speed:5,
  jump:-14,
  onGround:false
};

let move=0;
let cameraX=0;
let coinsCollected=0;

const platforms=[
  {x:0,y:450,w:3000,h:50},
  {x:350,y:360,w:140,h:20},
  {x:600,y:300,w:140,h:20},
  {x:850,y:240,w:140,h:20},
  {x:1100,y:320,w:140,h:20},
  {x:1400,y:260,w:140,h:20}
];

const coins=[
  {x:380,y:320,t:false},
  {x:630,y:260,t:false},
  {x:880,y:200,t:false},
  {x:1130,y:280,t:false},
  {x:1430,y:220,t:false}
];

const enemies=[
  {x:700,y:420,w:40,h:30,dir:1,start:700},
  {x:1250,y:420,w:40,h:30,dir:-1,start:1250}
];

const finish={x:1700,y:390,w:30,h:60};

function update(){

  player.vx = move * player.speed;

  player.vy += gravity;
  player.x += player.vx;
  player.y += player.vy;

  player.onGround=false;

  platforms.forEach(p=>{
    if(
      player.x < p.x+p.w &&
      player.x+player.w > p.x &&
      player.y < p.y+p.h &&
      player.y+player.h > p.y
    ){
      if(player.vy>0){
        player.y=p.y-player.h;
        player.vy=0;
        player.onGround=true;
      }
    }
  });

  coins.forEach(c=>{
    if(!c.t){
      if(Math.abs(player.x-c.x)<40 && Math.abs(player.y-c.y)<40){
        c.t=true;
        coinsCollected++;
        score.textContent="Coins: "+coinsCollected;
      }
    }
  });

  enemies.forEach(e=>{
    e.x+=e.dir*2;
    if(e.x<e.start-120 || e.x>e.start+120) e.dir*=-1;

    if(
      player.x < e.x+e.w &&
      player.x+player.w > e.x &&
      player.y < e.y+e.h &&
      player.y+player.h > e.y
    ){
      if(player.vy>0){
        e.dead=true;
        player.vy=-8;
      }else{
        restart();
      }
    }
  });

  for(let i=enemies.length-1;i>=0;i--){
    if(enemies[i].dead) enemies.splice(i,1);
  }

  if(
    player.x < finish.x+finish.w &&
    player.x+player.w > finish.x &&
    player.y < finish.y+finish.h &&
    player.y+player.h > finish.y
  ){
    alert("Уровень пройден!");
    restart();
  }

  cameraX = player.x - canvas.width/2;
}

function draw(){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.translate(-cameraX,0);

  // платформы
  ctx.fillStyle="#5c3a1e";
  platforms.forEach(p=>{
    ctx.fillRect(p.x,p.y,p.w,p.h);
  });

  // монеты
  coins.forEach(c=>{
    if(!c.t){
      ctx.beginPath();
      ctx.arc(c.x,c.y,10,0,Math.PI*2);
      ctx.fillStyle="gold";
      ctx.fill();
    }
  });

  // враги
  ctx.fillStyle="#2ecc71";
  enemies.forEach(e=>{
    ctx.fillRect(e.x,e.y,e.w,e.h);
  });

  // финиш
  ctx.fillStyle="#fff";
  ctx.fillRect(finish.x,finish.y,finish.w,finish.h);

  // игрок
  ctx.fillStyle="#ff3b3b";
  ctx.fillRect(player.x,player.y,player.w,player.h);

  ctx.restore();
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

function restart(){
  location.reload();
}

// джойстик
const joy=document.getElementById("joy");
const stick=document.getElementById("stick");

joy.addEventListener("pointerdown",handleJoy);
joy.addEventListener("pointermove",e=>{
  if(e.buttons) handleJoy(e);
});
joy.addEventListener("pointerup",resetJoy);
joy.addEventListener("pointerleave",resetJoy);

function handleJoy(e){
  const rect=joy.getBoundingClientRect();
  const x=e.clientX-rect.left-60;

  stick.style.left=(x+35)+"px";

  if(x<-20) move=-1;
  else if(x>20) move=1;
  else move=0;
}

function resetJoy(){
  move=0;
  stick.style.left="35px";
}

// прыжок
document.getElementById("jump").addEventListener("pointerdown",()=>{
  if(player.onGround) player.vy=player.jump;
});
</script>

</body>
</html>
