<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Platformer Mobile</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:linear-gradient(#87CEEB,#e8f7ff);
  touch-action:none;
}

canvas{display:block}

/* UI */
.score{
  position:fixed;
  top:15px;
  left:15px;
  background:#fff;
  padding:8px 12px;
  border-radius:10px;
  font-weight:bold;
}

.joy{
  position:fixed;
  bottom:30px;
  left:20px;
  width:130px;
  height:130px;
  background:#0002;
  border-radius:50%;
}

.stick{
  width:55px;
  height:55px;
  background:#0008;
  border-radius:50%;
  position:absolute;
  left:37px;
  top:37px;
}

.jump{
  position:fixed;
  right:30px;
  bottom:40px;
  width:95px;
  height:95px;
  border-radius:50%;
  border:none;
  font-size:30px;
  background:#ff5c5c;
  color:white;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div class="score" id="score">Coins: 0</div>

<div class="joy" id="joy">
  <div class="stick" id="stick"></div>
</div>

<button class="jump" id="jump">▲</button>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize",resize);

let gravity = 0.6;
let move = 0;
let cameraX = 0;
let coinsCount = 0;

const player = {
  x:100,
  y:0,
  w:40,
  h:50,
  vx:0,
  vy:0,
  speed:5,
  jump:-14,
  onGround:false
};

const platforms = [
  {x:0,y:450,w:2500,h:50},
  {x:300,y:360,w:140,h:20},
  {x:550,y:300,w:140,h:20},
  {x:800,y:240,w:140,h:20},
  {x:1050,y:330,w:140,h:20}
];

const coins = [
  {x:330,y:320,t:false},
  {x:580,y:260,t:false},
  {x:830,y:200,t:false},
  {x:1080,y:290,t:false}
];

const enemies = [
  {x:700,y:420,w:40,h:30,dir:1,start:700},
  {x:1200,y:420,w:40,h:30,dir:-1,start:1200}
];

const finish = {x:1500,y:390,w:30,h:60};

function update(){

  player.vx = move * player.speed;

  player.vy += gravity;
  player.x += player.vx;
  player.y += player.vy;

  player.onGround = false;

  platforms.forEach(p=>{
    if(
      player.x < p.x+p.w &&
      player.x+player.w > p.x &&
      player.y < p.y+p.h &&
      player.y+player.h > p.y
    ){
      if(player.vy>0){
        player.y = p.y-player.h;
        player.vy = 0;
        player.onGround = true;
      }
    }
  });

  coins.forEach(c=>{
    if(!c.t && Math.abs(player.x-c.x)<40 && Math.abs(player.y-c.y)<40){
      c.t = true;
      coinsCount++;
      score.textContent = "Coins: " + coinsCount;
    }
  });

  enemies.forEach(e=>{
    e.x += e.dir*2;
    if(e.x < e.start-120 || e.x > e.start+120) e.dir *= -1;

    if(
      player.x < e.x+e.w &&
      player.x+player.w > e.x &&
      player.y < e.y+e.h &&
      player.y+player.h > e.y
    ){
      if(player.vy>0){
        e.dead = true;
        player.vy = -8;
      } else {
        restart();
      }
    }
  });

  for(let i=enemies.length-1;i>=0;i--){
    if(enemies[i].dead) enemies.splice(i,1);
  }

  if(
    player.x < finish.x+finish.w &&
    player.x+player.w > finish.x &&
    player.y < finish.y+finish.h &&
    player.y+player.h > finish.y
  ){
    alert("Уровень пройден!");
    restart();
  }

  cameraX = player.x - canvas.width/2;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.translate(-cameraX,0);

  ctx.fillStyle="#5c3a1e";
  platforms.forEach(p=>{
    ctx.fillRect(p.x,p.y,p.w,p.h);
  });

  coins.forEach(c=>{
    if(!c.t){
      ctx.beginPath();
      ctx.arc(c.x,c.y,10,0,Math.PI*2);
      ctx.fillStyle="gold";
      ctx.fill();
    }
  });

  ctx.fillStyle="#2ecc71";
  enemies.forEach(e=>{
    ctx.fillRect(e.x,e.y,e.w,e.h);
  });

  ctx.fillStyle="white";
  ctx.fillRect(finish.x,finish.y,finish.w,finish.h);

  ctx.fillStyle="red";
  ctx.fillRect(player.x,player.y,player.w,player.h);

  ctx.restore();
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

function restart(){
  location.reload();
}

/* Джойстик */
const joy = document.getElementById("joy");
const stick = document.getElementById("stick");
let active = false;

joy.addEventListener("touchstart",e=>{
  active = true;
  moveJoy(e.touches[0]);
});

joy.addEventListener("touchmove",e=>{
  if(active) moveJoy(e.touches[0]);
});

joy.addEventListener("touchend",()=>{
  active = false;
  move = 0;
  stick.style.left="37px";
});

function moveJoy(touch){
  const rect = joy.getBoundingClientRect();
  const x = touch.clientX - rect.left - 65;

  stick.style.left = (x + 37) + "px";

  if(x < -25) move = -1;
  else if(x > 25) move = 1;
  else move = 0;
}

/* Прыжок */
document.getElementById("jump").addEventListener("touchstart",()=>{
  if(player.onGround){
    player.vy = player.jump;
  }
});
</script>

</body>
</html>
